version: 0.2

env:
  variables:
    APP_ENV: production
    APP_DEBUG: "false"
    COMPOSER_HOME: /tmp/composer

phases:
  install:
    commands:
      - echo "Prepare COMPOSER_HOME at $COMPOSER_HOME and ensure writable"
      - mkdir -p "$COMPOSER_HOME"
      - chmod 1777 "$COMPOSER_HOME" || true
      - echo "Installing composer if missing"
      - |
        if ! command -v composer >/dev/null 2>&1; then
          curl -sS https://getcomposer.org/installer -o /tmp/composer-setup.php
          php /tmp/composer-setup.php --install-dir=/usr/local/bin --filename=composer
        fi
      - echo "Composer version (using forced COMPOSER_HOME=$COMPOSER_HOME)"
      - COMPOSER_HOME=$COMPOSER_HOME composer --version || true
      - node -v || true
      - npm -v || true

  pre_build:
    commands:
      - echo "Preparing .env (do NOT store secrets in repo) - inject in deploy targets"
      - cp .env.example .env || true
      - echo "Installing PHP dependencies (production) with forced COMPOSER_HOME"
      - COMPOSER_HOME=$COMPOSER_HOME composer install --no-dev --prefer-dist --optimize-autoloader --no-interaction --no-ansi

  build:
    commands:
      - echo "Build frontend (if applicable)"
      - if [ -f package.json ]; then npm ci && npm run build || true; fi
      - echo "Performing artisan optimization (saf
